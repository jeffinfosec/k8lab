# Use local docker environment
#1. Clone a sample application from GitHub
git clone https://github.com/Azure-Samples/azure-voting-app-redis.git

#2. Create a container image
cd azure-voting-app-redis

#3. Builds, (re)creates, starts, and attaches to containers for a service.
docker-compose up -d

#4. Test the multi-container application in a local Docker environment over http://localhost:8080
docker images
docker ps   
docker-compose down

#5. delete all docker images
docker system prune -a --volumes
docker images -a -q | % { docker image rm $_ -f }
Remove-Item 'azure-voting-app-redis' -Recurse -Force

#6. Azure CLI#
az login
az account show
# Set subscription by Id
az account set --subscription XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
# Set subscription by Name
az account set --subscription "Company Subscription"
az account show

#7. Create Azure Resource Group
az group create --name AVAResourceGroup --location westus

#8. Create Resource Group and Azure Container Registry (ACR) instance
az acr create --resource-group AVAResourceGroup --name avaacr --sku Basic

#9. Display ARC login server
az acr list --resource-group AVAResourceGroup --query "[].{acrLoginServer:loginServer}" --output table
#avaacr.azurecr.io

#10. Tag a container image for ACR
docker tag mcr.microsoft.com/azuredocs/azure-vote-front:v1 avaacr.azurecr.io/azure-vote-front:v1

#11. Upload the image to ACR, #View images in your registry

az acr login --name avaacr
docker images
docker push avaacr.azurecr.io/azure-vote-front:v1

#12. list images
az acr repository list --name avaacr --output table

#Install the Kubernetes CLI (kubectl)
#Configure kubectl to connect to your AKS cluster

#13. CREATE AKS CLUSTER
az aks create --resource-group AVAResourceGroup --name AVAAKSCluster --node-count 2 --generate-ssh-keys --attach-acr avaacr 

#14. az aks install-cli
az aks get-credentials --resource-group AVAResourceGroup --name AVAAKSCluster 

#15. list acr login server
az acr list --resource-group AVAResourceGroup --query "[].{acrLoginServer:loginServer}" --output table

#16. Update a Kubernetes manifest files
notepad azure-vote-all-in-one-redis.yaml

##containers:
- name: azure-vote-front
  image: avaacr.azurecr.io/azure-vote-front:v1

#17. Run an application in Kubernetes
kubectl apply -f azure-vote-all-in-one-redis.yaml

#kubectl get service azure-vote-front --watch
#Test external IP address
#18. Clean up
az aks stop --name AVAAKSCluster --resource-group AVAResourceGroup 
az aks delete --name MyManagedCluster --resource-group MyResourceGroup
az group delete --name ExampleResourceGroup


